# Grafana 

The [grafana-compose](./grafana-compose.yml) file allows you to start a instance of Grafana with the 
`yesoreyeram-infinity-datasource` plugin installed.

This `yesoreyeram-infinity-datasource` plugin allow you to use CSV datasource with Grafana, that is perfect for Impact Framework and his CSV Exporter.

## Pre-requisites

- Docker installed (or equivalent, like Colima)
- Impact Framework installed to run the `ie` CLI
- An Impact Framework manifest that generate a CSV as output (you can refer to the `grafana.yml` manifest )

> [!NOTE]
> You can directly use the [following manifest](../manifests/complete-with-csv.yml) that is already configured to work with [this dashboard](./grafana-dashboard.json) 

## How to use it

- Run the Impact Engine with this command ` ie --manifest manifests/complete-with-csv.yml --output grafana-export.csv`

> [!NOTE]
> The `IE` generate the CSV files into the `grafana-data` folder that is mounted as a volume in the Grafana container.

- Run `docker-compose -f grafana/grafana-compose.yml up --build -d`
- Access to `http://localhost:3000` with the credentials `admin/admin`
- Configure the two datasources generated by `IE`:
  - Go to `Configuration` > `Data Sources` > `Add data source`
  - Search the CSV plugin, install it and then configure it with the following parameters:
    - Name: `grafana-export-ccf` or `grafana-export-energy` depending on your filename
    - Storage location: `Local`
    - Path: `/var/lib/grafana/csv/grafana-export-ccf.csv` or `/var/lib/grafana/csv/grafana-export-energy.csv` depending on your filename
- Import the [following dashboard](./grafana-dashboard.json) that is ready to use with those two datasets (and come from this [IF dashboard](https://github.com/Green-Software-Foundation/if/blob/main/grafana/if_grafana_config.json) following [this guide](https://github.com/Green-Software-Foundation/if/blob/main/grafana/if_grafana_config.json))

## How the Dashboard was configured

The idea is to combine the two datasets to compute the `energy` fields for each `instance-type`

- The two datasets was imported to the dashboard thanks to the `Mixed` datasource
- Some transformations was done to correctly display the data
  - a `Convert field type` transformation was done to set the right type for the `timestamp` (`Time`), `energy` (`Number`) and `instance-type` (`String`) fields
  - a `Merge series/tables` transformation is order to merge the two datasets into one 
  - a `Partition by values` transformation on the `instance-type` field in order to create a serie for each `instance-type`
